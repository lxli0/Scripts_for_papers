clc,clear
load('lajolla.mat')
lajolla=lajolla(20:150,:);
%% load data
Sample=[1.551224478	3.419711955	1.582700331	2.618426661	1.954787234	2.04192622	1.582446809	1.916430709		0	2.773844308	0	2.278057463	0	1.623564032	0	1.684400534		0	3.584705615	0.389538119	2.397454389	0.161421358	2.03163017	0.245753202	1.772100568		6.816917084	3.365356342	0.09738453	2.284029468	7.036289427	1.743714517	0.236274984	1.613949716		3.346554509	3.772413793	1.673414761	2.923076923	3.293301369	2.280597688	8.631536889	2.328262106
3.179706438	3.629880725	3.295380199	2.768490602	3.537234043	2.152278335	3.35106383	2.019188375		1.732210635	2.978988182	1.594307052	2.322952709	1.675531915	1.612253256	1.210106383	1.699680447		1.947690595	3.567224212	5.063995548	2.726572928	1.759594874	2.03163017	1.744283905	1.776155718		8.764607679	3.395587714	1.558152476	2.343994167	8.843712851	1.901865369	2.035192314	1.630170316		5.157224296	3.806896552	3.276429314	3.084615385	5.010411384	2.288652744	13.86354556	2.438510084
5.141045547	3.699790843	5.008846963	2.898522411	5.212765957	2.232217256	4.840425532	2.09151262		3.360495871	3.194164984	3.391184828	2.412911822	3.35106383	1.787249211	3.444148936	1.718813203		3.408458542	3.573489627	6.914301614	2.768717552	3.368704796	2.214111922	3.448905109	1.885644769		10.32276016	3.407839637	3.505843072	2.47565752	10.44723305	1.99107867	3.538097579	1.707218167		6.967850754	3.840229885	4.78539501	3.228846154	6.724832112	2.312356891	17.29642094	2.462444742
6.775822678	3.749702553	6.886971785	3.003497192	7.167553191	2.255137125	7.074468085	2.095436251		4.996453346	3.214028496	6.742182859	2.522742878	5.119680851	1.855786344	6.981382979	1.795050967		5.063995548	3.627527582	8.56983862	2.882421379	5.165434845	2.193836172	5.046349532	1.873479319		13.92598776	3.48017579	5.258764608	2.535681984	13.74881262	2.080291971	5.140159595	1.772100568		8.664135084	3.840229885	6.766060291	3.413461538	8.437235874	2.347797858	20.1531165	2.505863927
8.575257866	3.774557236	8.357090858	3.07846593	8.936170213	2.289453725	8.75	2.122143233		6.795495086	3.248899244	8.292565358	2.637767449	6.981382979	1.893910282	8.563829787	1.833159736		6.816917084	3.645785936	10.71229827	2.954458704	6.865195425	2.222222222	7.148083803	1.942416869		17.3344463	3.534572338	6.914301614	2.661318984	17.35320912	2.222222222	7.04285127	1.853203569		10.26813115	3.891954023	8.563357588	3.413461538	10.2471263	2.371514812	27.59168549	2.55381008
10.29246239	3.809436416	10.31803652	3.158392114	10.1462766	2.3009263	10.33244681	2.175461128		8.348631722	3.293811353	10.3318072	2.807829798	13.96276596	2.194669727	10.2393617	1.932110064		8.56983862	3.729676748	13.7312187	3.181806591	8.865585664	2.266828873	8.850031664	2.00729927		20.74290484	3.64266817	10.51752922	2.81122077	27.94718445	2.323600973	14.14543962	2.03163017		13.84982576	3.909195402	10.26387734	3.482692308	13.39224794	2.403235597	34.26380757	2.617302875
13.72844522	3.839130511	13.8303483	3.328302705	13.86968085	2.339151363	13.96276596	2.247901667		10.310561	3.348697372	13.60195164	2.89262912	17.12765957	2.221457609	13.86968085	2.000748321		10.22537563	3.730015419	17.3344463	3.194476873	10.77143675	2.400648824	10.45330884	2.092457421		27.85197551	3.739587857	13.92598776	2.925283189	34.74282433	2.380373074	17.64751997	2.133008921		17.05305183	3.886206897	13.94961019	3.592307692	17.30247184	2.427234286	41.22704501	2.653448179
17.0814105	3.898881236	17.09990256	3.428126126	17.31382979	2.377361257	17.03457447	2.312707305		13.90392311	3.538631664	17.03419672	3.017475843	20.75797872	2.271084459	17.03457447	2.065559016		13.92598776	3.814304668	20.64552031	3.284653022	14.26744131	2.400648824	13.95466009	2.181670722		34.57150807	3.758862225	17.23706177	3.128824493	nan	nan	20.9456971	2.165450122		20.63734611	3.972413793	17.06777547	3.701923077	20.63853288	2.458980683	54.67415441	2.737411574
20.76290499	3.928550038	20.78021671	3.487843126	20.75797872	2.396559744	20.75797872	2.347130087		17.09557463	3.538302853	20.71352724	3.102233009	27.83244681	2.339909797	20.75797872	2.141806893		17.23706177	3.862714707	27.75459098	3.518804212	17.56416025	2.408759124	17.554439	2.246553122		41.77796327	3.742436678	20.54813578	3.147401596	nan	nan	27.94378201	2.266828873		27.42768277	4.110344828	20.37731289	3.742307692	27.22056383	2.491162489	68.51524442	2.751005281
27.55224654	4.007978792	27.64588721	3.707488375	27.83244681	2.438769113	27.6462766	2.442561281		20.61083727	3.633092948	27.5821486	3.246757762	34.72074468	2.355493083	27.46010638	2.237227975		20.9376739	3.929104195	34.6688926	3.663416753	21.06113694	2.424979724	20.95371713	2.299270073		55.21702838	3.82871811	27.85197551	3.351759695	nan	nan	34.44000739	2.327656123		34.39956301	4.064367816	27.46899688	3.834615385	34.27927097	2.527320599	54.87517865	2.678753093
34.42283515	4.102423214	34.5989032	3.786900267	34.72074468	2.515188901	34.62765957	2.492370156		27.48516363	3.632384741	34.36952292	3.376266847	41.51595745	2.378675876	34.62765957	2.290849244		27.65720646	3.996111259	41.19365609	3.831815954	27.86042229	2.542579075	27.85677682	2.481751825		69.3377852	3.897239233	34.6688926	3.436686442	nan	nan	41.63470459	2.376317924		41.46914749	4.110344828	34.65254678	4.013461538	41.24385306	2.555641357	40.95273769	2.582988848
41.37565442	4.186843138	41.2243736	3.871353916	41.60904255	2.538376749	41.51595745	2.580196788		34.35830965	3.661724733	41.40555648	3.425622109	55.3856383	2.413649786	41.32978723	2.371061201		34.76627713	4.027398488	55.50918197	3.900376921	34.95377546	2.566909976	34.75205952	2.534468775		nan	nan	41.38842515	3.539493029	nan	nan	55.32319685	2.445255474		54.94670059	4.150574713	41.36803534	4.036538462	54.98409479	2.600520441	34.0002574	2.484247179
55.12450386	4.180418692	55.21047229	4.075241566	55.57180851	2.592367122	55.19946809	2.672194806		41.14961845	3.691073156	55.23034142	3.569430224	69.16223404	2.441014077	55.3856383	2.466881725		41.48580968	4.094405553	69.3377852	3.974804866	41.74820018	2.603406326	55.73440573	2.639902676		nan	nan	55.31441291	3.721339464	nan	nan	69.30770117	2.453365775		68.98989843	4.196551724	55.08279626	4.082692308	68.63290074	2.621913082	27.51705777	2.432516814
68.87158279	4.219066543	69.03820809	4.143929185	68.97606383	2.612106626	69.25531915	2.745201642		55.14083196	3.764751946	69.0563067	3.683190141	nan	nan	68.88297872	2.50183541		55.50918197	4.103240883	nan	nan	55.53268979	2.607461476	nan	nan		nan	nan	69.24040067	3.807720505	nan	nan	nan	nan		55.23049784	4.179310345	68.32512994	4.111538462	41.53564074	2.524381592	20.56121587	2.353336509
nan	nan	nan	nan	nan	nan	nan	nan		69.05237222	3.783350802	nan	nan	nan	nan	nan	nan		69.04563161	4.094076842	nan	nan	69.41779433	2.623682076	nan	nan		nan	nan	nan	nan	nan	nan	nan	nan		41.28283785	4.167816092	54.79992204	4.053846154	27.41553717	2.467714464	17.32533078	2.294217008
nan	nan	nan	nan	nan	nan	nan	nan		nan	nan	nan	nan	nan	nan	nan	nan		nan	nan	nan	nan	nan	nan	nan	nan		nan	nan	nan	nan	nan	nan	nan	nan		34.40042956	4.087356322	41.1852131	3.834615385	20.17194151	2.396320286	13.70756689	2.235046281
nan	nan	nan	nan	nan	nan	nan	nan		nan	nan	nan	nan	nan	nan	nan	nan		nan	nan	nan	nan	nan	nan	nan	nan		nan	nan	nan	nan	nan	nan	nan	nan		27.61182602	3.995402299	33.80992723	3.736538462	17.02681988	2.364599501	10.28141472	2.171988895
nan	nan	nan	nan	nan	nan	nan	nan		nan	nan	nan	nan	nan	nan	nan	nan		nan	nan	nan	nan	nan	nan	nan	nan		nan	nan	nan	nan	nan	nan	nan	nan		20.54072506	3.909195402	27.18976091	3.690384615	13.78353926	2.348515001	8.761295007	2.128748995
nan	nan	nan	nan	nan	nan	nan	nan		nan	nan	nan	nan	nan	nan	nan	nan		nan	nan	nan	nan	nan	nan	nan	nan		nan	nan	nan	nan	nan	nan	nan	nan		13.65896669	3.845977011	20.00766632	3.465384615	9.97349131	2.297143208	6.476745348	2.089318919
nan	nan	nan	nan	nan	nan	nan	nan		nan	nan	nan	nan	nan	nan	nan	nan		nan	nan	nan	nan	nan	nan	nan	nan		nan	nan	nan	nan	nan	nan	nan	nan		9.981734227	3.794252874	17.07596154	3.442307692	8.354540286	2.273451867	4.473226223	2.081225444
nan	nan	nan	nan	nan	nan	nan	nan		nan	nan	nan	nan	nan	nan	nan	nan		nan	nan	nan	nan	nan	nan	nan	nan		nan	nan	nan	nan	nan	nan	nan	nan		8.473059378	3.771264368	13.29654366	3.303846154	5.024530143	2.206495013	3.814350806	2.026363981
nan	nan	nan	nan	nan	nan	nan	nan		nan	nan	nan	nan	nan	nan	nan	nan		nan	nan	nan	nan	nan	nan	nan	nan		nan	nan	nan	nan	nan	nan	nan	nan		6.587649094	3.754022989	10.74721933	3.153846154	3.601224778	2.155443374	1.925798718	1.904827399
nan	nan	nan	nan	nan	nan	nan	nan		nan	nan	nan	nan	nan	nan	nan	nan		nan	nan	nan	nan	nan	nan	nan	nan		nan	nan	nan	nan	nan	nan	nan	nan		4.794743716	3.690804598	8.291034304	3.05	1.519716319	2.045617998	nan	nan
nan	nan	nan	nan	nan	nan	nan	nan		nan	nan	nan	nan	nan	nan	nan	nan		nan	nan	nan	nan	nan	nan	nan	nan		nan	nan	nan	nan	nan	nan	nan	nan		3.568133004	3.650574713	6.779339917	2.992307692	nan	nan	nan	nan
nan	nan	nan	nan	nan	nan	nan	nan		nan	nan	nan	nan	nan	nan	nan	nan		nan	nan	nan	nan	nan	nan	nan	nan		nan	nan	nan	nan	nan	nan	nan	nan		1.76916173	3.426436782	4.701169439	2.9	nan	nan	nan	nan
nan	nan	nan	nan	nan	nan	nan	nan		nan	nan	nan	nan	nan	nan	nan	nan		nan	nan	nan	nan	nan	nan	nan	nan		nan	nan	nan	nan	nan	nan	nan	nan		nan	nan	3.380847193	2.773076923	nan	nan	nan	nan
nan	nan	nan	nan	nan	nan	nan	nan		nan	nan	nan	nan	nan	nan	nan	nan		nan	nan	nan	nan	nan	nan	nan	nan		nan	nan	nan	nan	nan	nan	nan	nan		nan	nan	1.588825364	2.605769231	nan	nan	nan	nan
																																											
];
Sample_number=size(Sample,2)/2;

%% create colormap
range=0:size(lajolla,1)-1;
range=range*(Sample_number-1)/(size(lajolla,1)-1)+1;
color=nan(Sample_number,3);
for i=1:3
    color(:,i)=interp1(range,lajolla(:,i),1:Sample_number);
end
%% Process
for i=1:Sample_number
    P0=1e6*Sample(:,2*i-1);
    V0=Sample(:,2*i);
    [mean_P00,eta00]=process(P0,V0);
    mean_P0(i,1:length(mean_P00))=mean_P00;
    eta0(i,1:length(mean_P00))=eta00;
    figure(2)
    semilogy(mean_P00,eta00,'o','markersize',8, 'markerfacecolor',color(i,:),'MarkerEdgeColor', color(i,:));
    hold on;
end
figure(1)
grid on;
box on;
set(gca,'fontsize',16);
xlabel('Pressure (Pa)')
ylabel('Velocity (km/s)')
figure(2)
eta=reshape(eta0,1,[])';
jk=find(eta>0);
eta=eta(jk);
mean_P=reshape(mean_P0,1,[])';
mean_P=mean_P(jk);

%% curve fitting
nihe_y=log(eta);
nihe_x=log(mean_P);
p=polyfit(nihe_x,nihe_y,1);
w1=exp(p(2));w2=p(1);
xi=linspace(min(mean_P),max(mean_P),20);
semilogy(xi,w1.*xi.^(w2),'linewidth',1.5,'color','k');

%% set gca
xlabel('Pressure (Pa)')
ylabel('\eta (Pa^-^1)')
grid on;
box on;
set(gca,'fontsize',16);

%% output
output=[mean_P,eta];
output_nihe=[w1,w2,min(mean_P),max(mean_P)];
save ./Out_sensitivity/Macbeth_2007_out.txt -ascii output
save ./Out_sensitivity/Macbeth_2007_nihe.txt -ascii output_nihe
%}
%%
function [mean_P0,eta0]=process(P0,V0)
    jkf=find(~isnan(P0));
    P=P0(jkf);V=V0(jkf);
    figure(1)
    plot(P,V,'*-');hold on;
    eta0=zeros(1,length(P)-1);
    mean_P0=zeros(1,length(P)-1);
    for j=1:length(P)-1
        dV=V(j+1)-V(j);
        dP=P(j+1)-P(j);
        eta0(j)=dV/V(j)/dP;
        mean_P0(j)=(P(j+1)+P(j))/2;
    end
end

