clc,clear
load('lajolla.mat')
lajolla=lajolla(20:150,:);
%% load data
Sample=[0.2102 	3.7333 	4.9746 	4.7900 	6.1877 	5.1327 	14.6893 	2.9673 	9.0395 	2.9194 	14.7727 	3.1718 	29.5455 	3.4245 	5.6818 	3.1525 	14.5042 	3.0139 	19.9048 	3.1804 	6.7041 	2.9950 		4.6730 	3.8038 	4.8139 	4.3110 	10.5742 	5.0478 	42.4581 	3.1074 	11.1732 	2.7876 	17.7688 	3.1017 	23.2444 	3.2009 	8.5185 	2.8652 	37.6553 	3.2861 
2.4873 	3.8855 	9.5182 	5.0562 	9.5608 	5.2086 	20.3390 	3.0533 	11.2994 	3.0195 	18.1818 	3.2528 	40.9091 	3.4962 	6.8182 	3.2240 	18.8353 	3.1376 	23.1770 	3.2518 	8.8537 	3.0712 		8.0516 	3.9665 	7.0787 	4.4641 	16.1802 	5.2297 	49.1620 	3.2029 	15.6425 	2.8974 	22.1747 	3.1584 	27.6398 	3.2671 	13.8631 	2.9740 	47.4903 	3.3522 
3.6445 	4.0282 	16.2778 	5.2556 	14.0858 	5.4082 	25.9887 	3.1536 	13.5593 	3.1244 	25.0000 	3.3292 	50.0000 	3.5679 	9.0909 	3.2669 	29.7534 	3.3659 	29.8066 	3.3183 	15.3981 	3.2139 		9.1946 	4.0813 	9.3434 	4.6172 	20.7018 	5.5072 	71.5084 	3.3317 	21.2291 	3.0263 	28.8258 	3.2057 	36.4674 	3.3664 	18.1262 	3.0686 	57.3567 	3.3995 
7.0469 	4.2089 	20.8002 	5.4456 	20.8348 	5.5694 	31.6384 	3.2443 	19.2090 	3.2437 	30.6818 	3.3674 	60.2273 	3.6348 	13.6364 	3.3718 	39.6978 	3.4657 	39.7031 	3.4609 	19.7664 	3.3042 		15.9436 	4.3780 	16.0898 	4.9043 	24.0643 	5.6124 	80.4469 	3.3604 	24.5810 	3.0931 	38.7813 	3.2955 	48.6681 	3.4468 	23.5179 	3.1489 	69.4644 	3.4279 
10.4440 	4.3704 	25.3146 	5.6071 	30.9356 	5.7304 	39.5480 	3.3590 	25.9887 	3.3202 	39.7727 	3.4486 	70.4545 	3.6588 	20.4545 	3.4481 	48.5727 	3.5226 	50.7702 	3.5559 	28.6201 	3.3802 		20.4492 	4.5981 	20.6114 	5.1818 	30.7788 	5.7847 	98.3240 	3.4177 	29.0503 	3.1408 	48.7632 	3.3617 	56.4365 	3.4941 	28.9017 	3.2340 	77.1443 	3.4610 
14.9770 	4.5986 	30.9170 	5.6637 	43.2737 	5.9006 	73.4463 	3.5844 	30.5085 	3.3776 	51.1364 	3.5155 	79.5455 	3.6828 	23.8636 	3.4768 	59.7036 	3.5604 	59.6664 	3.5938 	49.7273 	3.4892 		24.9522 	4.8086 	25.1090 	5.3732 	40.8267 	5.9569 	120.6704 	3.4606 	40.2235 	3.2172 	58.7609 	3.4137 	77.6127 	3.5414 	37.5926 	3.3239 	98.0526 	3.5130 
20.6273 	4.8266 	39.9111 	5.8629 	61.1928 	6.0513 	81.3559 	3.6086 	39.5480 	3.4399 	60.2273 	3.5491 	100.0000 	3.7024 	29.5455 	3.5102 	70.8452 	3.5887 	69.6853 	3.6269 	70.9144 	3.5268 		29.4604 	5.0383 	29.6066 	5.5646 	49.7395 	6.0431 	141.8994 	3.4749 	61.4525 	3.3126 	79.9319 	3.4657 	99.9168 	3.5792 	47.4276 	3.3901 	116.7901 	3.5414 
24.0297 	5.0072 	52.2279 	5.9569 	81.3360 	6.1637 	102.8249 	3.6572 	49.7175 	3.4880 	70.4545 	3.5731 	122.7273 	3.7029 	37.5000 	3.5438 	79.7680 	3.6028 	79.7201 	3.6457 	79.8372 	3.5409 		40.6805 	5.4306 	40.7549 	5.6986 	60.8958 	6.2057 	159.7765 	3.4988 	69.2737 	3.3461 	98.8946 	3.4941 	120.0021 	3.6028 	56.1733 	3.4468 	136.6483 	3.5603 
30.7733 	5.1495 	61.1955 	6.0608 	101.4578 	6.1999 	122.0339 	3.7010 	71.1864 	3.5033 	81.8182 	3.5829 	142.0455 	3.7224 	102.2727 	3.6120 	102.0777 	3.6356 	100.9019 	3.6880 	98.8268 	3.5452 		50.7310 	5.6124 	51.8900 	5.7847 	69.8033 	6.2727 	181.0056 	3.5036 	79.3296 	3.3795 	118.9746 	3.5225 	138.9807 	3.6170 	66.0241 	3.5035 	156.5142 	3.5745 
40.9087 	5.4342 	81.3360 	6.1637 	121.5770 	6.2265 	144.6328 	3.7116 	82.4859 	3.5086 	103.4091 	3.6310 	162.5000 	3.7324 	125.0000 	3.6077 	121.0514 	3.6542 	120.9769 	3.7209 	120.0298 	3.5685 		60.7629 	5.7273 	60.8081 	5.8900 	82.0494 	6.3589 	nan	nan	nan	nan	137.9637 	3.5272 	159.0713 	3.6359 	78.1474 	3.5225 	176.3802 	3.5887 
51.0308 	5.6713 	101.4711 	6.2475 	142.8108 	6.2435 	162.7119 	3.7315 	102.8249 	3.5287 	121.5909 	3.6553 	184.0909 	3.7234 	140.9091 	3.6176 	140.0250 	3.6728 	141.0732 	3.7347 	140.1261 	3.5823 		70.7895 	5.8230 	69.7368 	6.0335 	100.9543 	6.4163 	nan	nan	nan	nan	159.1822 	3.5366 	181.4176 	3.6359 	96.8614 	3.5650 	nan	nan
58.8971 	5.8325 	120.4969 	6.3600 	160.7007 	6.2895 	181.9209 	3.7324 	122.0339 	3.5296 	143.1818 	3.6653 	nan	nan	163.6364 	3.6277 	160.1320 	3.6771 	161.1642 	3.7533 	160.2277 	3.5914 		81.9378 	5.9569 	80.8586 	6.0718 	122.0760 	6.4545 	nan	nan	nan	nan	180.4007 	3.5461 	nan	nan	116.7117 	3.5887 	nan	nan
71.2298 	5.9837 	142.8587 	6.4150 	181.9345 	6.3065 	nan	nan	142.3729 	3.5448 	164.7727 	3.6849 	nan	nan	184.0909 	3.6377 	181.3456 	3.6909 	182.3831 	3.7623 	180.3294 	3.6004 		101.9537 	6.0144 	100.8852 	6.1675 	140.9702 	6.4737 	nan	nan	nan	nan	nan	nan	nan	nan	138.7406 	3.6312 	nan	nan
82.4160 	6.0302 	160.7433 	6.4418 	nan	nan	nan	nan	163.8418 	3.5458 	186.3636 	3.6902 	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan		121.9697 	6.0718 	120.9038 	6.2344 	160.9888 	6.5407 	nan	nan	nan	nan	nan	nan	nan	nan	157.5173 	3.6359 	nan	nan
101.4445 	6.1522 	181.9797 	6.4684 	nan	nan	nan	nan	181.9209 	3.5658 	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan		141.9963 	6.1675 	140.9144 	6.2727 	182.1079 	6.5694 	nan	nan	nan	nan	nan	nan	nan	nan	176.2627 	3.6596 	nan	nan
120.4597 	6.2266 	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan		162.0096 	6.2153 	160.9330 	6.3397 	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan
141.6988 	6.2627 	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan		182.0175 	6.2440 	182.0494 	6.3589 	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan
161.8180 	6.2894 	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan		nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan
181.9372 	6.3160 	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan		nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan
];
Sample_number=size(Sample,2)/2;

%% create colormap
range=0:size(lajolla,1)-1;
range=range*(Sample_number-1)/(size(lajolla,1)-1)+1;
color=nan(Sample_number,3);
for i=1:3
    color(:,i)=interp1(range,lajolla(:,i),1:Sample_number);
end
%% Process
for i=1:Sample_number
    P0=1e6*Sample(:,2*i-1);
    V0=Sample(:,2*i);
    [mean_P00,eta00]=process(P0,V0);
    mean_P0(i,1:length(mean_P00))=mean_P00;
    eta0(i,1:length(mean_P00))=eta00;
    figure(2)
    semilogy(mean_P00,eta00,'o','markersize',8, 'markerfacecolor',color(i,:),'MarkerEdgeColor', color(i,:));
    hold on;
end
figure(1)
grid on;
box on;
set(gca,'fontsize',16);
xlabel('Pressure (Pa)')
ylabel('Velocity (km/s)')
figure(2)
eta=reshape(eta0,1,[])';
jk=find(eta>0);
eta=eta(jk);
mean_P=reshape(mean_P0,1,[])';
mean_P=mean_P(jk);

%% curve fitting
nihe_y=log(eta);
nihe_x=log(mean_P);
p=polyfit(nihe_x,nihe_y,1);
w1=exp(p(2));w2=p(1);
xi=linspace(min(mean_P),max(mean_P),20);
semilogy(xi,w1.*xi.^(w2),'linewidth',1.5,'color','k');

%% set gca
xlabel('Pressure (Pa)')
ylabel('\eta (Pa^-^1)')
grid on;
box on;
set(gca,'fontsize',16);

%% output
output=[mean_P,eta];
output_nihe=[w1,w2,min(mean_P),max(mean_P)];
save ./Out_sensitivity/Sano_1992_out.txt -ascii output
save ./Out_sensitivity/Sano_1992_nihe.txt -ascii output_nihe
%}
%%
function [mean_P0,eta0]=process(P0,V0)
    jkf=find(~isnan(P0));
    P=P0(jkf);V=V0(jkf);
    figure(1)
    plot(P,V,'*-');hold on;
    eta0=zeros(1,length(P)-1);
    mean_P0=zeros(1,length(P)-1);
    for j=1:length(P)-1
        dV=V(j+1)-V(j);
        dP=P(j+1)-P(j);
        eta0(j)=dV/V(j)/dP;
        mean_P0(j)=(P(j+1)+P(j))/2;
    end
end

