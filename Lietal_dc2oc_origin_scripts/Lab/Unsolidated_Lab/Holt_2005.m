clc,clear
load('lajolla.mat')
lajolla=lajolla(20:150,:);
%% load data
Sample=[0.063344073	238.5572694	0.064294472	309.623395	0.025233085	387.805634	0.229188645	643.5961819
0.264400916	277.5961344	0.245392942	355.773623	0.226717608	458.8242554	0.430863247	728.8280285
0.38538667	327.3139199	0.406152881	380.6087636	0.468689115	558.2598263	0.893422291	828.2113449
0.445736987	341.5128937	0.807981448	437.3666559	0.891141334	657.6526435	1.295298378	888.5225435
0.887529819	387.6013664	1.269827693	483.4503781	1.29335006	742.836986	1.757429742	955.9261033
1.329417691	440.7964515	1.851756812	511.7390665	1.795635769	813.7843514	2.07875954	991.3831596
1.730913618	472.6811998	2.132837225	536.5457047	2.177268364	859.8870752	3.263479029	1108.361993
2.232581568	497.4355836	3.236487707	589.5840263	3.301447457	948.4537092	4.367319591	1175.613539
3.376386394	554.0177107	4.319752136	617.7539545	4.385472206	1033.476538	5.45072658	1214.443386
4.499852688	589.2847505	5.483277735	649.4581872	5.489360287	1104.281391	6.694750948	1267.448455
5.142084604	628.2191065	6.606648989	677.6186145	6.633070073	1153.756905	7.818122202	1295.608882
5.663473327	628.0955959	7.709824271	695.1238734	7.756773967	1206.790477	8.881428259	1330.890174
6.786987141	666.915942	8.87330235	723.2747999	8.860044289	1231.402348	10.00513215	1383.923745
7.930174208	677.3050875	9.916364915	744.3476162	9.903534533	1284.454921	11.12845589	1408.530866
8.993385225	705.479766	11.03949857	754.7415121	11.04686416	1305.503985	12.29188645	1433.128486
10.21688098	722.9565224	12.18278068	772.2372702	12.19024131	1330.106356	13.35500242	1454.196552
11.30000285	740.4665317	13.24584913	789.7520299	13.2133455	1358.290535	14.49837957	1478.798923
12.46329085	754.4042331	14.3489769	803.7039825	14.33685931	1397.110881	15.60155485	1496.304181
13.58647203	768.3514353	15.41199783	817.6654359	15.39978521	1403.965722	nan	nan
14.66945133	775.2015257	nan	nan	nan	nan	nan	nan
15.79263251	789.1487279	nan	nan	nan	nan	nan	nan
];
Sample_number=size(Sample,2)/2;

%% create colormap
range=0:size(lajolla,1)-1;
range=range*(Sample_number-1)/(size(lajolla,1)-1)+1;
color=nan(Sample_number,3);
for i=1:3
    color(:,i)=interp1(range,lajolla(:,i),1:Sample_number);
end
%% Process
for i=1:Sample_number
    P0=1e6*Sample(:,2*i-1);
    V0=Sample(:,2*i);
    [mean_P00,eta00]=process(P0,V0);
    mean_P0(i,1:length(mean_P00))=mean_P00;
    eta0(i,1:length(mean_P00))=eta00;
    figure(2)
    semilogy(mean_P00,eta00,'o','markersize',8, 'markerfacecolor',color(i,:),'MarkerEdgeColor', color(i,:));
    hold on;
end
figure(1)
grid on;
box on;
set(gca,'fontsize',16);
xlabel('Pressure (Pa)')
ylabel('Velocity (km/s)')
figure(2)
eta=reshape(eta0,1,[])';
jk=find(eta>0);
eta=eta(jk);
mean_P=reshape(mean_P0,1,[])';
mean_P=mean_P(jk);

%% curve fitting
nihe_y=log(eta);
nihe_x=log(mean_P);
p=polyfit(nihe_x,nihe_y,1);
w1=exp(p(2));w2=p(1);
xi=linspace(min(mean_P),max(mean_P),20);
semilogy(xi,w1.*xi.^(w2),'linewidth',1.5,'color','k');

%% set gca
xlabel('Pressure (Pa)')
ylabel('\eta (Pa^-^1)')
grid on;
box on;
set(gca,'fontsize',16);

%% output
output=[mean_P,eta];
output_nihe=[w1,w2,min(mean_P),max(mean_P)];
save ./Out_sensitivity/Holt_2005_out.txt -ascii output
save ./Out_sensitivity/Holt_2005_nihe.txt -ascii output_nihe
%}
%%
function [mean_P0,eta0]=process(P0,V0)
    jkf=find(~isnan(P0));
    P=P0(jkf);V=V0(jkf);
    figure(1)
    plot(P,V,'*-');hold on;
    eta0=zeros(1,length(P)-1);
    mean_P0=zeros(1,length(P)-1);
    for j=1:length(P)-1
        dV=V(j+1)-V(j);
        dP=P(j+1)-P(j);
        eta0(j)=dV/V(j)/dP;
        mean_P0(j)=(P(j+1)+P(j))/2;
    end
end

