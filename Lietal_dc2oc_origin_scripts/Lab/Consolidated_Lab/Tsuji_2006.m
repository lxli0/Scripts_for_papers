clc,clear
load('lajolla.mat')
lajolla=lajolla(20:150,:);
%% load data
Pressure=[0
5
10
15
20
25
30
35
40
45
50
55];
Velocity=[5.6072 	5.4397 	5.0522 	4.9057 	4.8009 	4.6752 	4.1935 	4.0993 	2.6857 	2.6230 	4.0210 3.1429	3.3519 	3.2788 	2.6620 	2.2543 	2.7666 	1.7944 	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan	nan
5.9510 	5.7834 	5.3227 	5.3018 	5.2704 	5.2388 	4.6526 	4.5164 	nan	nan	4.4687 	4.1446 	4.0400 	3.9355 	3.3711 	nan	3.2561 	2.7125 	3.6755 	3.5605 	3.5031 	3.4090 	nan	3.3306 	3.0379 	3.1215 	2.8340 	2.6825 	3.0450 	2.7880 	2.4891 	2.6359 	2.3632 	2.0800 	nan	nan
6.0016 	5.8446 	5.3942 	5.3943 	5.4045 	5.3315 	4.7660 	4.6822 	4.2320 	4.0854 	4.6237 	4.4251 	4.2368 	4.0696 	3.5470 	3.3693 	3.2857 	2.6690 	3.6960 	3.5758 	3.5758 	3.4660 	nan	3.3301 	3.1420 	3.1420 	2.8911 	2.8336 	3.0970 	2.8767 	2.7142 	2.7194 	2.3785 	2.2526 	2.3208 	2.2736 
6.0312 	5.8743 	5.4554 	5.4971 	5.4554 	5.3505 	4.7956 	4.8166 	4.3873 	4.2930 	4.7160 	4.6114 	4.3082 	4.2142 	3.7230 	3.5557 	3.4511 	2.9913 	3.6956 	3.6015 	3.6433 	3.5022 	3.4551 	3.3610 	3.1938 	3.1572 	2.9691 	2.8802 	3.1385 	2.9183 	2.8238 	2.7452 	2.4672 	2.3676 	2.3623 	2.2784 
6.0504 	5.9039 	5.5269 	5.5060 	5.4849 	5.3802 	4.8987 	4.8461 	4.5426 	4.4482 	4.7769 	4.7247 	4.3798 	4.2751 	3.8677 	3.6585 	3.5645 	3.1044 	3.7108 	3.6220 	3.6533 	3.5383 	3.4599 	3.3606 	3.2090 	3.1829 	3.0261 	2.9216 	3.1696 	2.9598 	2.8863 	2.7919 	2.5297 	2.4930 	2.4615 	2.4038 
6.0905 	5.9545 	5.5776 	5.5775 	5.4937 	5.4099 	4.9387 	4.9282 	4.6037 	4.5620 	4.8381 	4.7962 	4.4304 	4.3256 	3.9912 	3.8031 	3.6882 	3.3851 	3.7156 	3.6477 	3.6420 	3.5640 	3.4961 	3.3758 	nan	3.2138 	3.0727 	2.9525 	3.2111 	2.9856 	2.9384 	2.8440 	2.5765 	2.5608 	2.5083 	2.5240 
6.1097 	5.9633 	5.6387 	5.5967 	5.5024 	5.4500 	5.0418 	4.9580 	4.6963 	4.6439 	4.8990 	4.8781 	4.5227 	4.4182 	4.1046 	3.9268 	3.7700 	3.5924 	3.7256 	3.6734 	3.6415 	3.5793 	3.5061 	3.3754 	3.2657 	3.2134 	3.0671 	2.9782 	3.2369 	3.0218 	2.9694 	2.8855 	2.6337 	2.6128 	2.5551 	nan
6.0871 	5.9614 	5.6473 	5.6579 	5.5635 	5.4589 	5.1028 	5.0295 	4.7154 	4.7363 	4.9180 	4.9285 	4.5523 	4.4478 	4.1759 	4.0089 	3.8729 	3.6742 	3.7252 	3.6781 	3.6620 	3.5893 	3.5370 	3.3855 	3.3018 	3.2391 	3.1189 	2.9935 	3.2417 	3.0424 	2.9795 	2.9270 	2.7015 	2.6543 	2.5704 	2.5232 
6.0959 	6.0017 	5.6874 	5.7189 	5.6038 	5.4780 	5.1117 	5.0593 	4.7556 	4.7452 	4.9582 	4.9478 	4.6132 	4.4878 	4.2474 	4.0801 	3.9025 	3.7665 	3.7457 	3.6934 	3.6668 	3.5993 	3.5575 	3.3850 	3.3328 	3.2439 	3.1603 	3.0296 	3.2727 	3.0682 	3.0000 	2.9685 	2.7325 	2.6853 	2.5962 	2.5962 
6.1465 	6.0523 	5.7276 	5.7276 	5.6019 	5.4868 	5.1725 	5.1203 	4.8270 	4.8375 	5.0296 	5.0297 	4.6428 	4.5279 	4.3085 	4.1935 	3.9531 	3.8275 	3.7504 	3.7086 	3.6768 	3.6198 	3.5779 	3.3898 	3.3689 	3.2539 	3.1860 	3.0501 	3.2828 	3.0625 	3.0101 	2.9891 	2.7845 	2.7268 	2.6219 	2.6534 
6.1343 	6.0505 	5.7677 	5.7363 	5.6209 	5.4955 	5.1918 	5.1395 	4.8463 	4.8254 	5.0382 	5.0592 	4.6516 	4.5261 	4.4007 	4.2647 	4.0348 	3.9198 	3.7605 	3.7134 	3.6712 	3.6298 	3.5827 	3.4155 	3.3894 	3.2744 	3.2274 	3.0653 	3.3033 	3.0778 	3.0411 	3.0096 	2.7999 	2.7526 	2.6635 	2.6687 
6.1325 	6.0488 	5.8499 	5.7660 	5.6507 	5.5148 	5.2005 	5.1692 	4.9701 	4.8237 	5.0785 	5.0470 	4.7022 	4.5975 	nan'	4.3363 	4.0748 	3.9808 	3.7600 	3.7078 	3.6816 	3.6816 	3.6137 	3.4203 	3.4046 	3.2740 	3.2321 	3.0858 	3.3186 	3.0879 	3.0721 	3.0407 	nan	2.7784 	2.6735 	2.7155 
];
Sample_number=size(Velocity,2);

%% create colormap
range=0:size(lajolla,1)-1;
range=range*(Sample_number-1)/(size(lajolla,1)-1)+1;
color=nan(Sample_number,3);
for i=1:3
    color(:,i)=interp1(range,lajolla(:,i),1:Sample_number);
end
%% Process
for i=1:Sample_number
    P0=1e6*Pressure;
    V0=Velocity(:,i);
    [mean_P00,eta00]=process(P0,V0);
    mean_P0(i,1:length(mean_P00))=mean_P00;
    eta0(i,1:length(mean_P00))=eta00;
    figure(2)
    semilogy(mean_P00,eta00,'o','markersize',8, 'markerfacecolor',color(i,:),'MarkerEdgeColor', color(i,:));
    hold on;
end
figure(1)
grid on;
box on;
set(gca,'fontsize',16);
xlabel('Pressure (Pa)')
ylabel('Velocity (km/s)')
figure(2)
eta=reshape(eta0,1,[])';
jk=find(eta>0);
eta=eta(jk);
mean_P=reshape(mean_P0,1,[])';
mean_P=mean_P(jk);

%% curve fitting
nihe_y=log(eta);
nihe_x=log(mean_P);
p=polyfit(nihe_x,nihe_y,1);
w1=exp(p(2));w2=p(1);
xi=linspace(min(mean_P),max(mean_P),20);
semilogy(xi,w1.*xi.^(w2),'linewidth',1.5,'color','k');

%% set gca
xlabel('Pressure (Pa)')
ylabel('\eta (Pa^-^1)')
grid on;
box on;
set(gca,'fontsize',16);

%% output
output=[mean_P,eta];
output_nihe=[w1,w2,min(mean_P),max(mean_P)];
save ./Out_sensitivity/Tsuji_2006_out.txt -ascii output
save ./Out_sensitivity/Tsuji_2006_nihe.txt -ascii output_nihe

%%
function [mean_P0,eta0]=process(P0,V0)
    jkf=find(~isnan(P0));
    P=P0(jkf);V=V0(jkf);
    figure(1)
    plot(P,V,'*-');hold on;
    eta0=zeros(1,length(P)-1);
    mean_P0=zeros(1,length(P)-1);
    for j=1:length(P)-1
        dV=V(j+1)-V(j);
        dP=P(j+1)-P(j);
        eta0(j)=dV/V(j)/dP;
        mean_P0(j)=(P(j+1)+P(j))/2;
    end
end

