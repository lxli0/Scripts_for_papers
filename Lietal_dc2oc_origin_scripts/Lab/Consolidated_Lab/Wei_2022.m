clc,clear
load('lajolla.mat')
lajolla=lajolla(20:150,:);
%% load data
Pressure1=[0
5
15
25
35
45
55];
Velocity1=[4.3570 	4.9202 	4.1849 	4.6099 	3.8485 	4.5030 	4.2370 	4.5030 	3.7494 	4.2814 	3.5538 	4.0597 	2.7300 	2.7897 	2.7967 	2.6844 	2.5580 	2.5732 	2.5908 	2.6048 	2.4784 	2.4784 	2.5908 	2.5334 
4.4537 	5.0534 	4.3155 	4.7144 	4.0156 	4.6232 	4.3416 	4.6310 	4.0234 	4.4537 	3.8513 	4.3676 	2.8623 	2.8471 	2.8635 	2.7242 	2.6563 	2.6575 	2.7394 	2.6516 	2.5814 	2.6224 	2.6832 	2.6130 
4.6445 	5.1555 	4.5402 	4.8322 	4.3941 	4.8009 	4.5506 	4.7696 	4.2794 	4.6445 	4.1412 	4.4984 	2.9770 	2.9138 	2.9571 	2.7815 	2.8260 	2.7698 	2.9079 	2.7488 	2.7511 	2.7312 	2.7125 	2.6633 
4.7987 	5.1821 	4.7179 	4.8744 	4.6032 	4.8822 	4.6579 	4.8118 	4.4937 	4.7283 	4.4180 	4.6058 	3.0566 	2.9594 	3.0414 	2.8389 	2.9267 	2.8225 	2.9828 	2.8038 	2.8611 	2.7839 	2.8365 	2.7289 
4.9426 	5.2320 	4.8122 	4.9348 	4.7575 	4.9035 	4.8044 	4.8618 	4.6036 	4.7731 	4.5150 	4.6923 	3.1186 	3.0858 	3.0893 	2.8705 	2.9980 	2.8939 	3.0367 	2.8599 	2.9278 	2.8213 	2.8845 	2.7722 
5.0473 	5.2664 	4.9065 	4.9795 	4.8361 	4.9300 	4.8387 	4.9352 	4.7031 	4.8205 	4.5571 	4.7084 	3.1771 	3.1163 	3.1373 	2.9173 	3.0250 	2.9173 	3.0554 	2.8869 	2.9805 	2.8681 	2.9196 	2.7967 
5.1234 	5.2929 	4.9591 	5.0373 	4.8783 	4.9800 	4.9096 	5.0113 	4.7766 	4.8652 	4.7114 	4.7557 	3.2368 	3.1268 	3.1689 	2.9489 	3.0554 	2.9466 	3.0847 	2.9278 	2.9980 	2.8880 	2.9618 	2.8190 ];
Pressure2=[2
5
10
15
20
30
40
50
60
70];
Velocity2=[4.7562 	4.9378 	4.7033 	4.8024 	4.9543 	5.3077 	nan	nan	nan	nan	nan	nan	2.8543 	2.8376 	2.7064 	2.6855 	2.9647 	2.9814 	nan	nan	nan	nan	nan	nan
nan	nan	nan	nan	nan	nan	5.0368 	5.6444 	4.4720 	4.7428 	4.1220 	4.1847 	nan	nan	nan	nan	nan	nan	2.9857 	3.0524 	2.6670 	2.8461 	2.2878 	2.3253 
4.8912 	5.0332 	4.8053 	4.9573 	5.0365 	5.4163 	5.1752 	5.8060 	4.6666 	4.9110 	4.1548 	4.4718 	2.9652 	2.9193 	2.7964 	2.8110 	3.0548 	3.0756 	3.1298 	3.2152 	2.8485 	2.8568 	2.4943 	2.3631 
nan	nan	nan	nan	nan	nan	5.3995 	5.8289 	4.7886 	4.9999 	4.2998 	4.6367 	nan	nan	nan	nan	nan	nan	3.2405 	3.3322 	2.9675 	2.9196 	2.6217 	2.4863 
5.0162 	5.1186 	nan	nan	5.0823 	5.5512 	5.5942 	5.9310 	4.9139 	5.0658 	4.4185 	4.8181 	3.0595 	2.9866 	2.9012 	2.8804 	3.1241 	3.1804 	3.3200 	3.3720 	3.0408 	2.9595 	2.6866 	2.5762 
5.0917 	5.2271 	4.9860 	5.1313 	5.1346 	5.6069 	5.7324 	6.0626 	5.1247 	5.2733 	4.6723 	4.9893 	3.1247 	3.0705 	2.9664 	2.9705 	3.1789 	3.2393 	3.4310 	3.4768 	3.1664 	3.0414 	2.7809 	2.6997 
5.1573 	5.3092 	5.0549 	5.2035 	5.1837 	5.6725 	5.7716 	6.1678 	5.2068 	5.3885 	4.8766 	5.0318 	3.1816 	3.1378 	3.0399 	3.0315 	3.2378 	3.3149 	3.5149 	3.5357 	3.2482 	3.1149 	2.8774 	2.8336 
5.1931 	5.3550 	5.0941 	5.2460 	5.2262 	5.7182 	5.8536 	6.1872 	5.3120 	5.4309 	4.9818 	5.1634 	3.2238 	3.1822 	3.0905 	3.0842 	3.2863 	3.3801 	3.5988 	3.6717 	3.3217 	3.1780 	2.9321 	2.9155 
5.2290 	5.4007 	5.1068 	5.2785 	5.2587 	5.7475 	5.9258 	6.1900 	5.3083 	5.4932 	5.0804 	5.1332 	3.2682 	3.2140 	3.1202 	3.1223 	3.3098 	3.4244 	3.6432 	3.7348 	3.3557 	3.2140 	2.9640 	2.9452 
5.2417 	5.4366 	5.1162 	5.2913 	5.2814 	5.7734 	5.9022 	6.2061 	5.3804 	5.5125 	5.1063 	5.2054 	3.2854 	3.2542 	3.1500 	3.1667 	3.3292 	3.4542 	3.6667 	3.6729 	3.3750 	3.2229 	2.9750 	2.9146 ];

Sample_number=size(Velocity1,2)+size(Velocity2,2);

%% create colormap
range=0:size(lajolla,1)-1;
range=range*(Sample_number-1)/(size(lajolla,1)-1)+1;
color=nan(Sample_number,3);
for i=1:3
    color(:,i)=interp1(range,lajolla(:,i),1:Sample_number);
end
%% Process
for i=1:Sample_number
    if i<=size(Velocity1,2)
        P0=1e6*Pressure1;
        V0=Velocity1(:,i);
    else
        P0=1e6*Pressure2;
        V0=Velocity2(:,i-size(Velocity1,2));
    end   
    [mean_P00,eta00]=process(P0,V0);
    mean_P0(i,1:length(mean_P00))=mean_P00;
    eta0(i,1:length(mean_P00))=eta00;
    figure(2)
    semilogy(mean_P00,eta00,'o','markersize',8, 'markerfacecolor',color(i,:),'MarkerEdgeColor', color(i,:));
    hold on;
end
figure(1)
grid on;
box on;
set(gca,'fontsize',16);
xlabel('Pressure (Pa)')
ylabel('Velocity (km/s)')
figure(2)
eta=reshape(eta0,1,[])';
jk=find(eta>0);
eta=eta(jk);
mean_P=reshape(mean_P0,1,[])';
mean_P=mean_P(jk);

%% curve fitting
nihe_y=log(eta);
nihe_x=log(mean_P);
p=polyfit(nihe_x,nihe_y,1);
w1=exp(p(2));w2=p(1);
xi=linspace(min(mean_P),max(mean_P),20);
semilogy(xi,w1.*xi.^(w2),'linewidth',1.5,'color','k');

%% set gca
xlabel('Pressure (Pa)')
ylabel('\eta (Pa^-^1)')
grid on;
box on;
set(gca,'fontsize',16);

%% output
output=[mean_P,eta];
output_nihe=[w1,w2,min(mean_P),max(mean_P)];
save ./Out_sensitivity/Wei_2022_out.txt -ascii output
save ./Out_sensitivity/Wei_2022_nihe.txt -ascii output_nihe

%%
function [mean_P0,eta0]=process(P0,V0)
    jkf=find(~isnan(P0));
    P=P0(jkf);V=V0(jkf);
    figure(1)
    plot(P,V,'-*');hold on;
    eta0=zeros(1,length(P)-1);
    mean_P0=zeros(1,length(P)-1);
    for j=1:length(P)-1
        dV=V(j+1)-V(j);
        dP=P(j+1)-P(j);
        eta0(j)=dV/V(j)/dP;
        mean_P0(j)=(P(j+1)+P(j))/2;
    end
end

