clc,clear
%% initial parameters
rho=2.7e3;
g=9.8;
P_rgh=rho*g*1e3;
load('lajolla.mat')
lajolla=lajolla(20:150,:);
%% load data
Sample=[
    10.0143	4886.3014	4.8641	4776.7123	10.0463	2775.1870	5.0022	2582.5010	1.0282	4562.3876	1.1693	4705.5482	1.0000	2589.5105	1.0000	2515.3846	4.9805	4065.4073	1.0117	4090.6650	4.9053	2426.4100	5.0125	2312.0783
15.0215	4945.2055	9.9428	4854.7945	15.0444	2792.8722	10.0733	2627.9653	5.0300	4628.7800	5.1442	4716.1506	5.0000	2607.6923	5.0000	2534.9650	10.0389	4143.5057	4.9805	4186.8574	9.9481	2448.2459	10.0485	2360.4387
19.9571	4963.0137	15.0215	4884.9315	20.0407	2804.0758	15.0733	2653.0579	10.0942	4653.0875	10.1998	4722.5632	10.0000	2616.0839	10.0000	2553.1469	14.9416	4236.1010	9.9611	4283.0804	14.8366	2466.4268	15.0128	2385.9350
25.0358	4991.7808	20.1001	4931.5068	25.0359	2810.6498	19.9395	2668.8887	15.1705	4702.6583	15.3534	4782.6618	15.0000	2617.4825	15.0000	2554.5455	19.9222	4285.1940	14.8638	4344.8599	20.1149	2479.1110	24.9470	2414.9761
30.0429	5005.4795	24.9642	4941.0959	30.0311	2817.2238	25.0680	2682.8726	20.2312	4719.5973	20.1884	4780.6491	20.0000	2627.2727	20.0000	2560.1399	24.9027	4339.7252	19.9222	4399.3934	24.8502	2489.0637	29.9149	2426.7528
35.1216	5019.1781	29.9714	4960.2740	34.9600	2821.9447	29.8665	2691.2948	25.1404	4721.7965	25.0279	4788.1101	25.0000	2631.4685	25.0000	2567.1329	29.9611	4388.8206	24.9027	4424.9215	29.9743	2497.1782	34.9608	2436.6984
40.0572	5028.7671	34.9785	4984.9315	40.0201	2825.7421	35.0593	2699.7243	30.2702	4732.4210	30.2279	4794.5254	30.0000	2639.8601	30.0000	2572.7273	34.9416	4407.0979	29.8833	4446.8243	34.8664	2501.6395	39.9303	2442.0725
45.1359	5034.2466	39.9857	4989.0411	45.0141	2827.6864	39.9875	2701.6674	35.1819	4739.8834	35.1376	4797.7773	35.0000	2644.0559	35.0000	2576.9231	40.0000	4441.6918	34.8638	4483.2285	39.9133	2507.9266	44.8998	2447.4467
39.9142	5019.1781	34.8355	4984.9315	40.0187	2820.1865	34.9917	2692.3156	40.1617	4738.9261	40.1881	4793.6634	40.0000	2646.8531	40.0000	2582.5175	44.9805	4454.5311	39.8444	4488.8171	49.8551	2507.6993	49.7923	2450.0787
34.9070	5009.5890	30.0429	4957.5342	35.0243	2816.3903	29.9303	2683.8886	45.0689	4736.9147	45.1689	4794.8114	45.0000	2648.2517	45.0000	2582.5175	49.9611	4480.0592	44.9805	4496.2230	44.8851	2504.1544	44.9791	2441.0425
29.9714	4990.4110	24.8927	4941.0959	29.8320	2809.8127	25.0004	2675.4639	50.2007	4751.7498	50.1564	4809.6437	50.0000	2653.8462	50.0000	2585.3147	44.9805	4454.5311	49.9611	4523.5638	39.8387	2496.0380	40.0106	2432.0097
24.8927	4971.2329	19.9571	4917.8082	24.8366	2802.3128	20.0030	2660.5566	45.0770	4753.7570	45.1735	4804.2852	45.0000	2649.6503	nan	nan	39.8444	4447.1252	44.9805	4516.1626	34.8699	2487.9199	34.8865	2423.8952
20.0286	4949.3151	14.8784	4880.8219	19.9711	2789.2597	14.9380	2638.2406	40.0936	4747.3458	40.1901	4797.8740	40.0000	2648.2517	nan	nan	34.9416	4443.3517	39.9222	4501.5082	29.9011	2479.8019	29.9961	2413.0314
14.9499	4891.7808	9.9428	4813.6986	15.1054	2775.2807	10.0025	2608.5195	35.0370	4738.8280	35.2113	4800.9366	35.0000	2645.4545	nan	nan	29.8833	4432.3228	34.9416	4479.6055	24.8571	2462.5391	25.0292	2397.5962
9.9428	4871.2329	4.9356	4734.2466	9.9059	2740.9252	4.9316	2563.9812	30.1243	4729.2603	30.1608	4805.0505	30.0000	2641.2587	nan	nan	24.8249	4392.2908	29.9611	4450.4520	20.0448	2449.8443	20.0633	2378.5024
nan	nan	0.9299	4643.8356	nan	nan	nan	nan	25.0707	4727.0583	25.1042	4796.5326	25.0000	2637.0629	nan	nan	19.9222	4388.5173	24.9805	4424.9239	15.0015	2429.8377	15.0211	2353.9226
nan	nan	nan	nan	nan	nan	nan	nan	20.1605	4722.7538	20.0506	4794.3307	20.0000	2630.0699	nan	nan	15.0195	4324.9251	19.8444	4410.2672	9.8830	2399.7718	10.0587	2321.1092
nan	nan	nan	nan	nan	nan	nan	nan	15.1060	4718.4465	15.2121	4788.9749	15.0000	2627.2727	nan	nan	9.9611	4252.2647	14.9416	4352.1130	4.9955	2377.9323	5.1754	2282.8063
nan	nan	nan	nan	nan	nan	nan	nan	9.9752	4705.7168	10.0656	4743.6132	10.0000	2621.6783	nan	nan	4.9805	4154.2290	9.8833	4283.0780	nan	nan	nan	nan
nan	nan	nan	nan	nan	nan	nan	nan	4.8988	4656.1459	5.0817	4736.1494	5.0000	2617.4825	nan	nan	nan	nan	4.8249	4204.9796	nan	nan	nan	nan
nan	nan	nan	nan	nan	nan	nan	nan	0.7294	4541.3293	1.0417	4740.2826	1.0000	2592.3077	nan	nan	nan	nan	0.9339	4155.9195	nan	nan	nan	nan
];
Sample_number=size(Sample,2)/2;

%% create colormap
range=0:size(lajolla,1)-1;
range=range*(Sample_number-1)/(size(lajolla,1)-1)+1;
color=nan(Sample_number,3);
for i=1:3
    color(:,i)=interp1(range,lajolla(:,i),1:Sample_number);
end
%% Process
for i=1:Sample_number
    P0=1e6*Sample(:,2*i-1);
    V0=Sample(:,2*i);
    [mean_P00,eta00]=process(P0,V0);
    mean_P0(i,1:length(mean_P00))=mean_P00;
    eta0(i,1:length(mean_P00))=eta00;
    figure(2)
    semilogy(mean_P00,eta00,'o','markersize',8, 'markerfacecolor',color(i,:),'MarkerEdgeColor', color(i,:));
    hold on;
end
figure(1)
grid on;
box on;
set(gca,'fontsize',16);
xlabel('Pressure (Pa)')
ylabel('Velocity (km/s)')
figure(2)
eta=reshape(eta0,1,[])';
jk=find(eta>0);
eta=eta(jk);
mean_P=reshape(mean_P0,1,[])';
mean_P=mean_P(jk);

%% curve fitting
nihe_y=log(eta);
nihe_x=log(mean_P);
p=polyfit(nihe_x,nihe_y,1);
w1=exp(p(2));w2=p(1);
xi=linspace(min(mean_P),max(mean_P),20);
semilogy(xi,w1.*xi.^(w2),'linewidth',1.5,'color','k');

%% set gca
xlabel('Pressure (Pa)')
ylabel('\eta (Pa^-^1)')
grid on;
box on;
set(gca,'fontsize',16);

%% output
output=[mean_P,eta];
output_nihe=[w1,w2,min(mean_P),max(mean_P)];
save ./Out_sensitivity/Njiekak_2019_out.txt -ascii output
save ./Out_sensitivity/Njiekak_2019_nihe.txt -ascii output_nihe
%%
function [mean_P0,eta0]=process(P0,V0)
    jkf=find(~isnan(P0));
    P=P0(jkf);V=V0(jkf);
    figure(1)
    plot(P,V,'*-');hold on;
    eta0=zeros(1,length(P)-1);
    mean_P0=zeros(1,length(P)-1);
    for j=1:length(P)-1
        dV=V(j+1)-V(j);
        dP=P(j+1)-P(j);
        eta0(j)=dV/V(j)/dP;
        mean_P0(j)=(P(j+1)+P(j))/2;
    end
end

